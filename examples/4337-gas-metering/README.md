# 4337 Gas Metering Analysis

## How to run?

1. Rename the `.env.example` to `.env`.
2. Fill the required values of `.env`.
3. Based on which paymaster to run, check the `package.json` file to see the `script`. Furthermore, you can check the `README.md` files in the corresponding paymaster folders to see the individual command and their possible results.

NOTE: If you run a paymaster analysis twice or more without changing the salt for Safe Creation, then only the operation will execute through paymaster (if any), rather than Safe Creation and Operation.

## Gas Usage Results

|                                                                  | **With 4337?** | **Account Creation**                                                                                                                                                                                                                                  | **Account Creation + Native Transfer**                                                                                                                                                                                                                | **Native Transfer**                                                                                                                                                                                                                                   | **Account Creation + ERC20 Transfer**                                                                                                                                                                                                                 | **ERC20 Transfer**                                                                                                                                                                                                                                    | **Account Creation + ERC721 Minting**                                                                                                                                                                                                                 | **ERC721 Minting**                                                                                                                                                                                                                                    |
| ---------------------------------------------------------------- | -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **[Without Paymaster](../../modules/4337/test/gas/Gas.spec.ts)** | Yes            | 415213                                                                                                                                                                                                                                                | 447632                                                                                                                                                                                                                                                | 182081                                                                                                                                                                                                                                                | 426139                                                                                                                                                                                                                                                | 160575                                                                                                                                                                                                                                                | 467926                                                                                                                                                                                                                                                | 202374                                                                                                                                                                                                                                                |
| **Gelato (4337 Compatible - 1Balance)**                          | No             | 302679 ([TX](https://sepolia.basescan.org/tx/0x1b2f743dff63dfc6e01e18623cb8d692d4a1cf206008358fac3eaf8fd5957c91)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x1b2f743dff63dfc6e01e18623cb8d692d4a1cf206008358fac3eaf8fd5957c91/gas-usage)) | 313228 ([TX](https://sepolia.basescan.org/tx/0xddbd655b8a11cf043c535c2d6dbe14aa82925d444a0d4bb5378670993ad1862c)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xddbd655b8a11cf043c535c2d6dbe14aa82925d444a0d4bb5378670993ad1862c/gas-usage)) | 83930 ([TX](https://sepolia.basescan.org/tx/0x162b8817fe9cbbccb905c4b51cc25cbf2625afa1e5341087a4e79b9bb6834fc6)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x162b8817fe9cbbccb905c4b51cc25cbf2625afa1e5341087a4e79b9bb6834fc6/gas-usage))  | 315961 ([TX](https://sepolia.basescan.org/tx/0x1043acb58c89667d26360f23532d6eee4ab927b20ba37035fb3ffb8cc71c224b)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x1043acb58c89667d26360f23532d6eee4ab927b20ba37035fb3ffb8cc71c224b/gas-usage)) | 86852 ([TX](https://sepolia.basescan.org/tx/0x6c6ccadea5e54aa47b36c603132b315f1cf15e75e96c0376a7c76ae48f69a006)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x6c6ccadea5e54aa47b36c603132b315f1cf15e75e96c0376a7c76ae48f69a006/gas-usage))  | 345284 ([TX](https://sepolia.basescan.org/tx/0xd49b482ff37f07f12fc1688a2af33b4451d63409fe547f9cf2e660422866da3e)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xd49b482ff37f07f12fc1688a2af33b4451d63409fe547f9cf2e660422866da3e/gas-usage)) | 116159 ([TX](https://sepolia.basescan.org/tx/0x5814be99c937b6e7386f3526fe9f11fc1bf7a21180daf66ee2e44cc1e4d0da3d)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x5814be99c937b6e7386f3526fe9f11fc1bf7a21180daf66ee2e44cc1e4d0da3d/gas-usage)) |
| **Pimlico - EntryPoint v0.7 (Base Sepolia - ERC20 Paymaster)**   | Yes            | 487605 ([TX](https://sepolia.basescan.org/tx/0xc44f5d2f26a71663f15f0c257bc557707179161578508c2c9a1095b53a69daa7)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xc44f5d2f26a71663f15f0c257bc557707179161578508c2c9a1095b53a69daa7/gas-usage)) | 494988 ([TX](https://sepolia.basescan.org/tx/0xcbd6cbce4bb5ca257968fc583b401b66a6d4658ed75e5eabecc895db1305e647)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xcbd6cbce4bb5ca257968fc583b401b66a6d4658ed75e5eabecc895db1305e647/gas-usage)) | 182388 ([TX](https://sepolia.basescan.org/tx/0xae8555a827966d28414a1110ac73ced970115a2e3c5a7400490b8fbc9dc42624)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xae8555a827966d28414a1110ac73ced970115a2e3c5a7400490b8fbc9dc42624/gas-usage)) | 514156 ([TX](https://sepolia.basescan.org/tx/0x8302c8a2f381067855091c97d091bcfc566e4112a33e65b34fbfadb5c5318c66)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x8302c8a2f381067855091c97d091bcfc566e4112a33e65b34fbfadb5c5318c66/gas-usage)) | 185479 ([TX](https://sepolia.basescan.org/tx/0xa1b9fc3edefc8cf824b37151d55aa0e7319ab8f8c3e2affd1aba4d19efba3a91)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xa1b9fc3edefc8cf824b37151d55aa0e7319ab8f8c3e2affd1aba4d19efba3a91/gas-usage)) | 527408 ([TX](https://sepolia.basescan.org/tx/0xfca26170369c63b0c4c6abcb4bcb569376e180310a4f2c4b37dbf3b6de2a9fd5)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xfca26170369c63b0c4c6abcb4bcb569376e180310a4f2c4b37dbf3b6de2a9fd5/gas-usage)) | 214759 ([TX](https://sepolia.basescan.org/tx/0xe5a0e1aa8f714e354730344b1110f0225993d6885d68d7b9c8e309da800190a1)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xe5a0e1aa8f714e354730344b1110f0225993d6885d68d7b9c8e309da800190a1/gas-usage)) |
| **Pimlico - EntryPoint v0.7 (Sepolia - Verifying Paymaster)**    | Yes            | 396009 ([TX](https://sepolia.etherscan.io/tx/0x5a9119d67f76203ebfbdb641d7620d41242502cffa4a10b801a79a463ef60893)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x5a9119d67f76203ebfbdb641d7620d41242502cffa4a10b801a79a463ef60893/gas-usage)       | 403404 ([TX](https://sepolia.etherscan.io/tx/0x9c92c03c6f6abee15c8b7857d1dfa0d3aec517b7d116ae6f8b1034e192667a75)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x9c92c03c6f6abee15c8b7857d1dfa0d3aec517b7d116ae6f8b1034e192667a75/gas-usage))      | 120355 ([TX](https://sepolia.etherscan.io/tx/0xb01f64d8db284a6f05fa7083a242bb238f44a70e49a55d6046e99c2f9029dc3f)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xb01f64d8db284a6f05fa7083a242bb238f44a70e49a55d6046e99c2f9029dc3f/gas-usage))      | 423670 ([TX](https://sepolia.etherscan.io/tx/0x2c23f209eb25208bb977fb81992dbc072201ab8d4d7dd2a2c527558c6d22a6b6)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x2c23f209eb25208bb977fb81992dbc072201ab8d4d7dd2a2c527558c6d22a6b6/gas-usage))      | 123494 ([TX](https://sepolia.etherscan.io/tx/0x556a93d3481866744217adacc930c05544293053068ce3bba81d6af81b18d12e)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x556a93d3481866744217adacc930c05544293053068ce3bba81d6af81b18d12e/gas-usage))      | 452929 ([TX](https://sepolia.etherscan.io/tx/0x45ee84ab39fed43d2d2399aaa3e9aa9ebe2a65691d80d4e169b0c6efd21ec3cb)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x45ee84ab39fed43d2d2399aaa3e9aa9ebe2a65691d80d4e169b0c6efd21ec3cb/gas-usage))      | 152766 ([TX](https://sepolia.etherscan.io/tx/0x22b94bd700109d5d46b5f1da1414e5c582cc1bedc9418371d24e320bfc0d44eb)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x22b94bd700109d5d46b5f1da1414e5c582cc1bedc9418371d24e320bfc0d44eb/gas-usage))      |
| **Alchemy - EntryPoint v0.7 (ETH from Safe)**                    | Yes            | 416662 ([TX](https://sepolia.etherscan.io/tx/0x2bb40b0b95fc3d05353999cc54914ef64a782bf293ce24d277692a1f1dfa6723)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x2bb40b0b95fc3d05353999cc54914ef64a782bf293ce24d277692a1f1dfa6723/gas-usage))      | 424151 ([TX](https://sepolia.etherscan.io/tx/0x987d5135e1abe3549718a83864ef6c7836bc5fc6772511255d9b390590463cc1)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x987d5135e1abe3549718a83864ef6c7836bc5fc6772511255d9b390590463cc1/gas-usage))      | 107057 ([TX](https://sepolia.etherscan.io/tx/0x19684108660cd6867d0da53e7e87676e2726294a81e848d83b36fcd13cfa2396)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x19684108660cd6867d0da53e7e87676e2726294a81e848d83b36fcd13cfa2396/gas-usage))      | 432155 ([TX](https://sepolia.etherscan.io/tx/0xa969638360d89ea2c7252a6e1bd800b5d2f4d1f063be4de7fd74cadb67d82cdf)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xa969638360d89ea2c7252a6e1bd800b5d2f4d1f063be4de7fd74cadb67d82cdf/gas-usage))      | 114238 ([TX](https://sepolia.etherscan.io/tx/0x635a84cf3badd0a47daeb47b4aea9c20dcf69f6056cea96bb4d227c8b4d42c54)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x635a84cf3badd0a47daeb47b4aea9c20dcf69f6056cea96bb4d227c8b4d42c54/gas-usage))      | 456602 ([TX](https://sepolia.etherscan.io/tx/0x53f1b1f500fcae32f613af858790fa7d3dfbad594cec3ca492714179c1488cba)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x53f1b1f500fcae32f613af858790fa7d3dfbad594cec3ca492714179c1488cba/gas-usage))      | 138712 ([TX](https://sepolia.etherscan.io/tx/0x7017308881f1e5aac88945f2d4b3c177fc9a65bbbdd70dae2cac51885b4b4621)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x7017308881f1e5aac88945f2d4b3c177fc9a65bbbdd70dae2cac51885b4b4621/gas-usage))      |
| **Alchemy - EntryPoint v0.7 (ETH - Gas Policy)**                 | Yes            | 410072 ([TX](https://sepolia.etherscan.io/tx/0x0a188a69a31a462cec2b18efdec329a4dbe908683be613985280f1e622623c5e)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x0a188a69a31a462cec2b18efdec329a4dbe908683be613985280f1e622623c5e/gas-usage))      | 417573 ([TX](https://sepolia.etherscan.io/tx/0x3036e647c00d319300fd25df9dcc7042b7e23e6adf7849874a63fc013a3745fd)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x3036e647c00d319300fd25df9dcc7042b7e23e6adf7849874a63fc013a3745fd/gas-usage))      | 128393 ([TX](https://sepolia.etherscan.io/tx/0xe8bb10cdf0e0974b11a80671ca18a8b67d06c5b631fc88dce5dc860041f0443c)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xe8bb10cdf0e0974b11a80671ca18a8b67d06c5b631fc88dce5dc860041f0443c/gas-usage))      | 425630 ([TX](https://sepolia.etherscan.io/tx/0x36d9ef6cdf53b95b9e681223feb1be25ad2a87b0e70e9302a34c0b5ed1e42bfb)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x36d9ef6cdf53b95b9e681223feb1be25ad2a87b0e70e9302a34c0b5ed1e42bfb/gas-usage))      | 136452 ([TX](https://sepolia.etherscan.io/tx/0x5231d8901c4265d944b31fed5dd997dfbde2c401fd023f969d6ce6278950d274)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x5231d8901c4265d944b31fed5dd997dfbde2c401fd023f969d6ce6278950d274/gas-usage))      | 450060 ([TX](https://sepolia.etherscan.io/tx/0xba87280426c3c5e0987a0570b3d0a34c3790971b01e3ff4b15799d89c88f2f2b)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xba87280426c3c5e0987a0570b3d0a34c3790971b01e3ff4b15799d89c88f2f2b/gas-usage))      | 160895 ([TX](https://sepolia.etherscan.io/tx/0x98fc15b72ba5a7ac9495b335bc1af84d4f774c4d72845211c6aeae6651dcd56f)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x98fc15b72ba5a7ac9495b335bc1af84d4f774c4d72845211c6aeae6651dcd56f/gas-usage))      |

## Detailed Individual Gas Usage Results

### Pimlico - EntryPoint v0.7 (Base Sepolia ERC20 Paymaster)

| Type                               | Actual Gas | handleOps | \_createSenderIfNeeded       | Safe Proxy Factory | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | ---------------------------- | ------------------ | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 487605     | 456569    | Wasn't included in the trace | 295395             | 11856                 | 24381           | 6424                 | 4411                      |
| Account Creation + Native Transfer | 494988     | 463940    | Wasn't included in the trace | 295395             | 11856                 | 31752           | 13795                | 11782                     |
| Native Transfer                    | 182388     | 158296    | NA                           | NA                 | 15536                 | 33798           | 15795                | 13782                     |
| Account Creation + ERC20 Transfer  | 498115     | 471111    | Wasn't included in the trace | 295395             | 11883                 | 38804           | 20784                | 18528                     |
| ERC20 Transfer                     | 185479     | 165467    | NA                           | NA                 | 15536                 | 40850           | 22784                | 20528                     |
| Account Creation + ERC721 Minting  | 527408     | 495792    | Wasn't included in the trace | 295395             | 11874                 | 63524           | 45525                | 43351                     |
| ERC721 Minting                     | 214759     | 190147    | NA                           | NA                 | 15554                 | 65570           | 47525                | 45351                     |

### Pimlico - EntryPoint v0.7 (Sepolia - Verifying Paymaster)

| Type                               | Actual Gas | handleOps | \_createSenderIfNeeded       | Safe Proxy Factory | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | ---------------------------- | ------------------ | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 414071     | 366053    | Wasn't included in the trace | 264042             | 11771                 | 14542           | 6424                 | 4411                      |
| Account Creation + Native Transfer | 421350     | 373424    | Wasn't included in the trace | 264042             | 11771                 | 21913           | 13795                | 11782                     |
| Native Transfer                    | 137723     | 94935     | NA                           | NA                 | 15572                 | 23930           | 15795                | 13782                     |
| Account Creation + ERC20 Transfer  | 446477     | 397746    | Wasn't included in the trace | 264042             | 11798                 | 46088           | 37906                | 35650                     |
| ERC20 Transfer                     | 145721     | 102154    | NA                           | NA                 | 15599                 | 31004           | 22806                | 20550                     |
| Account Creation + ERC721 Minting  | 470905     | 422417    | Wasn't included in the trace | 264042             | 11789                 | 70808           | 62647                | 60473                     |
| ERC721 Minting                     | 170150     | 126826    | NA                           | NA                 | 15590                 | 55724           | 47547                | 45373                     |

### Alchemy - EntryPoint v0.7 (ETH from Safe)

| Type                               | Actual Gas | handleOps | createProxyWithNonce | ValidateUserOp (Safe)          | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | -------------------- | ------------------------------ | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 416662     | 409872    | 264042               | 43620 (incl. `depositTo` call) | 34416           | 6424                 | 4411                      |
| Account Creation + Native Transfer | 424151     | 409239    | 264042               | 43620 (incl. `depositTo` call) | 41787           | 13795                | 11782                     |
| Native Transfer                    | 106237     | 81973     | NA                   | 15518                          | 23893           | 15795                | 13782                     |
| Account Creation + ERC20 Transfer  | 432155     | 416424    | 264042               | 43647 (incl. `depositTo` call) | 48862           | 20806                | 18550                     |
| ERC20 Transfer                     | 114238     | 89157     | NA                   | 15545                          | 30969           | 22806                | 20550                     |
| Account Creation + ERC721 Minting  | 456602     | 441106    | 264042               | 43638 (incl. `depositTo` call) | 73582           | 45547                | 43373                     |
| ERC721 Minting                     | 138712     | 113841    | NA                   | 15536                          | 55689           | 47547                | 45373                     |

### Alchemy - EntryPoint v0.7 (ETH - Gas Policy)

| Type                               | Actual Gas | handleOps | createProxyWithNonce | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | -------------------- | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 410072     | 373790    | 264042               | 11762                 | NA              | NA                   | NA                        |
| Account Creation + Native Transfer | 417573     | 381161    | 264042               | 11762                 | 21913           | 13795                | 11782                     |
| Native Transfer                    | 128393     | 102544    | NA                   | 15563                 | 23933           | 15795                | 13782                     |
| Account Creation + ERC20 Transfer  | 425630     | 388400    | 264042               | 11789                 | 28988           | 20806                | 18550                     |
| ERC20 Transfer                     | 136452     | 109783    | NA                   | 15590                 | 31007           | 22806                | 20550                     |
| Account Creation + ERC721 Minting  | 450060     | 413064    | 264042               | 11780                 | 53708           | 45547                | 43373                     |
| ERC721 Minting                     | 160895     | 134449    | NA                   | 15581                 | 55727           | 45547                | 45373                     |
