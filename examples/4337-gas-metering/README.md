# 4337 Gas Metering Analysis

## How to run?

1. Rename the `.env.example` to `.env`.
2. Fill the required values of `.env`.
3. Based on which paymaster to run, check the `package.json` file to see the `script`. Furthermore, you can check the `README.md` files in the corresponding paymaster folders to see the individual command and their possible results.

NOTE: If you run a paymaster analysis twice or more without changing the salt for Safe Creation, then only the operation will execute through paymaster (if any), rather than Safe Creation and Operation.

## Gas Usage Results

|                                                                  | **With 4337?** | **Account Creation**                                                                                                                                                                                                                                  | **Account Creation + Native Transfer**                                                                                                                                                                                                                | **Native Transfer**                                                                                                                                                                                                                                  | **Account Creation + ERC20 Transfer**                                                                                                                                                                                                                 | **ERC20 Transfer**                                                                                                                                                                                                                                   | **Account Creation + ERC721 Minting**                                                                                                                                                                                                                 | **ERC721 Minting**                                                                                                                                                                                                                                    |
| ---------------------------------------------------------------- | -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **[Without Paymaster](../../modules/4337/test/gas/Gas.spec.ts)** | Yes            | 415213                                                                                                                                                                                                                                                | 447632                                                                                                                                                                                                                                                | 182081                                                                                                                                                                                                                                               | 426139                                                                                                                                                                                                                                                | 160575                                                                                                                                                                                                                                               | 467926                                                                                                                                                                                                                                                | 202374                                                                                                                                                                                                                                                |
| **Gelato (4337 Compatible - 1Balance)**                          | No             | 302679 ([TX](https://sepolia.basescan.org/tx/0x1b2f743dff63dfc6e01e18623cb8d692d4a1cf206008358fac3eaf8fd5957c91)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x1b2f743dff63dfc6e01e18623cb8d692d4a1cf206008358fac3eaf8fd5957c91/gas-usage)) | 313228 ([TX](https://sepolia.basescan.org/tx/0xddbd655b8a11cf043c535c2d6dbe14aa82925d444a0d4bb5378670993ad1862c)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xddbd655b8a11cf043c535c2d6dbe14aa82925d444a0d4bb5378670993ad1862c/gas-usage)) | 83930 ([TX](https://sepolia.basescan.org/tx/0x162b8817fe9cbbccb905c4b51cc25cbf2625afa1e5341087a4e79b9bb6834fc6)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x162b8817fe9cbbccb905c4b51cc25cbf2625afa1e5341087a4e79b9bb6834fc6/gas-usage)) | 315961 ([TX](https://sepolia.basescan.org/tx/0x1043acb58c89667d26360f23532d6eee4ab927b20ba37035fb3ffb8cc71c224b)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x1043acb58c89667d26360f23532d6eee4ab927b20ba37035fb3ffb8cc71c224b/gas-usage)) | 86852 ([TX](https://sepolia.basescan.org/tx/0x6c6ccadea5e54aa47b36c603132b315f1cf15e75e96c0376a7c76ae48f69a006)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x6c6ccadea5e54aa47b36c603132b315f1cf15e75e96c0376a7c76ae48f69a006/gas-usage)) | 345284 ([TX](https://sepolia.basescan.org/tx/0xd49b482ff37f07f12fc1688a2af33b4451d63409fe547f9cf2e660422866da3e)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0xd49b482ff37f07f12fc1688a2af33b4451d63409fe547f9cf2e660422866da3e/gas-usage)) | 116159 ([TX](https://sepolia.basescan.org/tx/0x5814be99c937b6e7386f3526fe9f11fc1bf7a21180daf66ee2e44cc1e4d0da3d)) ([Gas](https://dashboard.tenderly.co/tx/base-sepolia/0x5814be99c937b6e7386f3526fe9f11fc1bf7a21180daf66ee2e44cc1e4d0da3d/gas-usage)) |
| **Pimlico - EntryPoint v0.6 (USDC Paymaster)**                   | Yes            | 506573 ([TX](https://mumbai.polygonscan.com/tx/0x3c6284e4df1686d699d2bc4cca04a25ecc76d68a73665ca53d466e6bd6bedf28)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0x3c6284e4df1686d699d2bc4cca04a25ecc76d68a73665ca53d466e6bd6bedf28/gas-usage))     | 511055 ([TX](https://mumbai.polygonscan.com/tx/0x8bc4e42b076d22e0fc3418eba40c65caab6e3a10c1fbb10cbeee4a7fbfa8b4b3)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0x8bc4e42b076d22e0fc3418eba40c65caab6e3a10c1fbb10cbeee4a7fbfa8b4b3/gas-usage))     | 199262 ([TX](https://mumbai.polygonscan.com/tx/0x46cdfc14649087609f69411fc41f5feb4dc23a6ea9255928b932841858e5f186)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0x46cdfc14649087609f69411fc41f5feb4dc23a6ea9255928b932841858e5f186/gas-usage))    | 514156 ([TX](https://mumbai.polygonscan.com/tx/0xa5cf461800341c2e9934608ff55aeda26d1a3e7da4f5bc9f3cce3fd185409623)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0xa5cf461800341c2e9934608ff55aeda26d1a3e7da4f5bc9f3cce3fd185409623/gas-usage))     | 202387 ([TX](https://mumbai.polygonscan.com/tx/0xdc21ae13dc92eb48851fa62f57c74f3a0085acf81343d9aaaa14fcc3c6911f91)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0xdc21ae13dc92eb48851fa62f57c74f3a0085acf81343d9aaaa14fcc3c6911f91/gas-usage))    | 543411 ([TX](https://mumbai.polygonscan.com/tx/0xcd6c137474be4f002822498e032ad9b78b0505bd4db495ee65fc602ec1a7f006)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0xcd6c137474be4f002822498e032ad9b78b0505bd4db495ee65fc602ec1a7f006/gas-usage))     | 231619 ([TX](https://mumbai.polygonscan.com/tx/0x31732175d3f3b35c9c2a38e841bcd485085edf79e7f3c532ec7997c4993c0192)) ([Gas](https://dashboard.tenderly.co/tx/mumbai/0x31732175d3f3b35c9c2a38e841bcd485085edf79e7f3c532ec7997c4993c0192/gas-usage))     |
| **Pimlico - EntryPoint v0.7 (Sepolia - Verifying Paymaster)**    | Yes            | 396009 ([TX](https://sepolia.etherscan.io/tx/0x5a9119d67f76203ebfbdb641d7620d41242502cffa4a10b801a79a463ef60893)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x5a9119d67f76203ebfbdb641d7620d41242502cffa4a10b801a79a463ef60893/gas-usage)       | 403404 ([TX](https://sepolia.etherscan.io/tx/0x9c92c03c6f6abee15c8b7857d1dfa0d3aec517b7d116ae6f8b1034e192667a75)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x9c92c03c6f6abee15c8b7857d1dfa0d3aec517b7d116ae6f8b1034e192667a75/gas-usage))      | 120355 ([TX](https://sepolia.etherscan.io/tx/0xb01f64d8db284a6f05fa7083a242bb238f44a70e49a55d6046e99c2f9029dc3f)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xb01f64d8db284a6f05fa7083a242bb238f44a70e49a55d6046e99c2f9029dc3f/gas-usage))     | 423670 ([TX](https://sepolia.etherscan.io/tx/0x2c23f209eb25208bb977fb81992dbc072201ab8d4d7dd2a2c527558c6d22a6b6)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x2c23f209eb25208bb977fb81992dbc072201ab8d4d7dd2a2c527558c6d22a6b6/gas-usage))      | 123494 ([TX](https://sepolia.etherscan.io/tx/0x556a93d3481866744217adacc930c05544293053068ce3bba81d6af81b18d12e)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x556a93d3481866744217adacc930c05544293053068ce3bba81d6af81b18d12e/gas-usage))     | 452929 ([TX](https://sepolia.etherscan.io/tx/0x45ee84ab39fed43d2d2399aaa3e9aa9ebe2a65691d80d4e169b0c6efd21ec3cb)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x45ee84ab39fed43d2d2399aaa3e9aa9ebe2a65691d80d4e169b0c6efd21ec3cb/gas-usage))      | 152766 ([TX](https://sepolia.etherscan.io/tx/0x22b94bd700109d5d46b5f1da1414e5c582cc1bedc9418371d24e320bfc0d44eb)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x22b94bd700109d5d46b5f1da1414e5c582cc1bedc9418371d24e320bfc0d44eb/gas-usage))      |
| **Alchemy - EntryPoint v0.6 (ETH from Safe)**                    | Yes            | 417074 ([TX](https://sepolia.etherscan.io/tx/0x03c507f5dc14c6b6af04c5ad722f0650d86925837d9889e4972cb087e34d7b88)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x03c507f5dc14c6b6af04c5ad722f0650d86925837d9889e4972cb087e34d7b88/gas-usage))      | 424505 ([TX](https://sepolia.etherscan.io/tx/0x0263331d8d4568c08d4a700385c08062ee0342fe6f65b2c7eb1a194ddec23ec2)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x0263331d8d4568c08d4a700385c08062ee0342fe6f65b2c7eb1a194ddec23ec2/gas-usage))      | 107057 ([TX](https://sepolia.etherscan.io/tx/0xf4e38d9f3535dcb9519ca3527734a5ea611a0d1bafb632051736537853eb502b)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xf4e38d9f3535dcb9519ca3527734a5ea611a0d1bafb632051736537853eb502b/gas-usage))     | 427599 ([TX](https://sepolia.etherscan.io/tx/0x794b02531f14b6c432c0dcf08d1cb76a8693dd75b35c5dde0d4547754d208143)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x794b02531f14b6c432c0dcf08d1cb76a8693dd75b35c5dde0d4547754d208143/gas-usage))      | 110174 ([TX](https://sepolia.etherscan.io/tx/0xb56985ee07b1e7931aedc387698620d890c99992c4c688b8b3a150f355089e5d)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xb56985ee07b1e7931aedc387698620d890c99992c4c688b8b3a150f355089e5d/gas-usage))     | 456870 ([TX](https://sepolia.etherscan.io/tx/0x2d2a0c8215821f0aa9cf8f88175aa8256cdca1a2928f2aa667916e5127f5dcb6)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x2d2a0c8215821f0aa9cf8f88175aa8256cdca1a2928f2aa667916e5127f5dcb6/gas-usage))      | 139420 ([TX](https://sepolia.etherscan.io/tx/0x178d2c16a261dcb49e810bf39ce35cf96cbab8c7d3235709c7164ba6193c716e)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x178d2c16a261dcb49e810bf39ce35cf96cbab8c7d3235709c7164ba6193c716e/gas-usage))      |
| **Alchemy - EntryPoint v0.6 (ETH - Gas Policy)**                 | Yes            | 411372 ([TX](https://sepolia.etherscan.io/tx/0xcbb2c3c49b9d72d9ecf692308d69a8ad797ab5b1c6603f4fad989f966d692af1)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xcbb2c3c49b9d72d9ecf692308d69a8ad797ab5b1c6603f4fad989f966d692af1/gas-usage))      | 418779 ([TX](https://sepolia.etherscan.io/tx/0x49fbedf833cfecf9db7de56c61d4227292723115520600dbc3711da5e6a85672)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x49fbedf833cfecf9db7de56c61d4227292723115520600dbc3711da5e6a85672/gas-usage))      | 130202 ([TX](https://sepolia.etherscan.io/tx/0x35f1e5b04d988e4614a17609190b3e21b0a9892f78da9f400248cfb3b5afde9a)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x35f1e5b04d988e4614a17609190b3e21b0a9892f78da9f400248cfb3b5afde9a/gas-usage))     | 421926 ([TX](https://sepolia.etherscan.io/tx/0x7dda913ae986d49c4322f414102ae374441a40adb4b33727e568ba140904d52a)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0x7dda913ae986d49c4322f414102ae374441a40adb4b33727e568ba140904d52a/gas-usage))      | 133394 ([TX](https://sepolia.etherscan.io/tx/0xe34902ebd5377cac04c47d142f6ca2de558df63a7e0c6541f704df651b7cfcb1)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xe34902ebd5377cac04c47d142f6ca2de558df63a7e0c6541f704df651b7cfcb1/gas-usage))     | 451200 ([TX](https://sepolia.etherscan.io/tx/0xb1253508bc4ca5ce41222b15b0e7bf03b2273bcb09d93e1d6d6a5ea39b43ee84)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xb1253508bc4ca5ce41222b15b0e7bf03b2273bcb09d93e1d6d6a5ea39b43ee84/gas-usage))      | 162654 ([TX](https://sepolia.etherscan.io/tx/0xd13fb70626a26aaa02e0389cd9347c1c0d8d8ed9ee794a61c5d3eea4b36e239a)) ([Gas](https://dashboard.tenderly.co/tx/sepolia/0xd13fb70626a26aaa02e0389cd9347c1c0d8d8ed9ee794a61c5d3eea4b36e239a/gas-usage))      |

## Detailed Individual Gas Usage Results

### Pimlico - EntryPoint v0.6 (USDC Paymaster)

| Type                               | Actual Gas | handleOps | \_createSenderIfNeeded | Safe Proxy Factory | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | ---------------------- | ------------------ | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 506573     | 475433    | 321191                 | 307459             | 15039                 | 65040           | 7015                 | 4411                      |
| Account Creation + Native Transfer | 511055     | 479867    | 321191                 | 307459             | 15039                 | 69474           | 14386                | 11782                     |
| Native Transfer                    | 199262     | 175066    | NA                     | NA                 | 20527                 | 71487           | 16386                | 13782                     |
| Account Creation + ERC20 Transfer  | 514156     | 487060    | 321210                 | 307459             | 15085                 | 76548           | 21415                | 18550                     |
| ERC20 Transfer                     | 202387     | 182259    | NA                     | NA                 | 20573                 | 78561           | 23415                | 20550                     |
| Account Creation + ERC721 Minting  | 543411     | 511739    | 321204                 | 307459             | 15069                 | 101268          | 46150                | 43373                     |
| ERC721 Minting                     | 231619     | 206939    | NA                     | NA                 | 20558                 | 103281          | 48150                | 45373                     |

### Pimlico - EntryPoint v0.7 (Sepolia - Verifying Paymaster)

| Type                               | Actual Gas | handleOps | \_createSenderIfNeeded       | Safe Proxy Factory | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | ---------------------------- | ------------------ | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 414071     | 366053    | Wasn't included in the trace | 264042             | 11771                 | 14542           | 6424                 | 4411                      |
| Account Creation + Native Transfer | 421350     | 373424    | Wasn't included in the trace | 264042             | 11771                 | 21913           | 13795                | 11782                     |
| Native Transfer                    | 137723     | 94935     | NA                           | NA                 | 15572                 | 23930           | 15795                | 13782                     |
| Account Creation + ERC20 Transfer  | 446477     | 397746    | Wasn't included in the trace | 264042             | 11798                 | 46088           | 37906                | 35650                     |
| ERC20 Transfer                     | 145721     | 102154    | NA                           | NA                 | 15599                 | 31004           | 22806                | 20550                     |
| Account Creation + ERC721 Minting  | 470905     | 422417    | Wasn't included in the trace | 264042             | 11789                 | 70808           | 62647                | 60473                     |
| ERC721 Minting                     | 170150     | 126826    | NA                           | NA                 | 15590                 | 55724           | 47547                | 45373                     |

### Alchemy - EntryPoint v0.6 (ETH from Safe)

| Type                               | Actual Gas | handleOps | \_createSenderIfNeeded | Safe Proxy Factory | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | ---------------------- | ------------------ | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 417074     | 407850    | 283735                 | 267761             | 47159                 | 34826           | 7015                 | 4411                      |
| Account Creation + Native Transfer | 424505     | 415221    | 283735                 | 267761             | 47159                 | 42197           | 14386                | 13795                     |
| Native Transfer                    | 107057     | 83301     | NA                     | NA                 | 20512                 | 24297           | 16386                | 15795                     |
| Account Creation + ERC20 Transfer  | 427599     | 422407    | 283754                 | 267761             | 47205                 | 49272           | 21415                | 20806                     |
| ERC20 Transfer                     | 110174     | 90486     | NA                     | NA                 | 20558                 | 31372           | 23415                | 20550                     |
| Account Creation + ERC721 Minting  | 456870     | 447090    | 283748                 | 267761             | 47190                 | 73991           | 46150                | 43373                     |
| ERC721 Minting                     | 139420     | 115168    | NA                     | NA                 | 20542                 | 56091           | 48150                | 45373                     |

### Alchemy - EntryPoint v0.6 (ETH - Gas Policy)

| Type                               | Actual Gas | handleOps | \_createSenderIfNeeded | Safe Proxy Factory | ValidateUserOp (Safe) | \_executeUserOp | executeUserOp (Safe) | execTransactionFromModule |
| ---------------------------------- | ---------- | --------- | ---------------------- | ------------------ | --------------------- | --------------- | -------------------- | ------------------------- |
| Account Creation                   | 411372     | 380632    | 281451                 | 267761             | 14992                 | 14932           | 7015                 | 4411                      |
| Account Creation + Native Transfer | 418779     | 388003    | 281451                 | 14992              | 22303                 | 14386           | 11782                |                           |
| Native Transfer                    | 130202     | 104878    | NA                     | NA                 | 15320                 | 24310           | 16386                | 15795                     |
| Account Creation + ERC20 Transfer  | 421926     | 395254    | 281471                 | 15038              | 29378                 | 21415           | 20806                | 18550                     |
| ERC20 Transfer                     | 133394     | 112126    | NA                     | NA                 | 20618                 | 31385           | 23415                | 20550                     |
| Account Creation + ERC721 Minting  | 451200     | 419916    | 281464                 | 15023              | 54097                 | 46150           |                      | 43373                     |
| ERC721 Minting                     | 162654     | 136786    | NA                     | NA                 | 20603                 | 56103           | 48150                | 45373                     |
